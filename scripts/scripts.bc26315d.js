"use strict";angular.module("nordeashApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","tc.chartjs"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("nordeashApp").controller("MainCtrl",["$scope","$timeout","Bank","Chart",function(a,b,c,d){a.chartoptions=d.chartoptions,a.banks=["Nordea","Osuuspankki"],a.my={bank:"Nordea"},a.timeInterval=[],a.upload=function(b){console.log(a.my.bank),a.my.bank&&(a.loading=!0,c.upload("csvFile",a.my.bank,e))};var e=function(c){a.timeInterval.push(c[0].date),a.timeInterval.push(c[c.length-1].date);var d,e,f,g=[],h=[],i={},j={};moment.locale("fi"),_.map(c,function(a){e=moment(a.date,"DD.MM.YYYY").format("MMM YYYY"),f=parseFloat(a.sum.replace(",",".")),f>0?(j[e]||(j[e]={sum:0}),j[e].sum+=f):(i[e]||(i[e]={sum:0}),i[e].sum+=-1*f)});for(var k=moment(a.timeInterval[0],"DD.MM.YYYY"),l=moment(a.timeInterval[1],"DD.MM.YYYY"),m=k.format("M"),n=k.format("YYYY"),o=l.format("M"),p=l.format("YYYY"),q=[],r=m;o>=r&&n==p&&12>=r||n!=p&&12>=r;r++)q.push(moment(n+"-"+r,"YYYY-M").format("MMM YYYY"));for(var s=parseInt(n)+1;p>=s;s++)for(var r=1;o>=r&&s==p&&12>=r||s!=p&&12>=r;r++)q.push(moment(s+"-"+r,"YYYY-M").format("MMM YYYY"));a.chartdata={labels:q,datasets:[{label:"Menot",fillColor:"rgba(0,0,0,0)",strokeColor:"#fa4789",pointColor:"#fa4789",pointStrokeColor:"#eee",pointHighlightFill:"#B2305F",data:_.map(q,function(a){return i[a]&&i[a].sum?Math.round(10*i[a].sum)/10:0})},{label:"Tulot",fillColor:"rgba(0,0,0,0)",strokeColor:"#44AAE5",pointColor:"#44AAE5",pointStrokeColor:"#eee",pointHighlightFill:"#399ACE",data:_.map(q,function(a){return j[a]&&j[a].sum?Math.round(10*j[a].sum)/10:0})}]},d=_.groupBy(c,function(a){return a.target.toLowerCase().trim()}),_.map(d,function(a,b){var c,d=[],e=[];_.map(a,function(a){parseFloat(a.sum.replace(",","."))>0?e.push(a):d.push(a)}),d.length&&(c=Math.round(_.reduce(d,function(a,b){var c=-1*parseFloat(b.sum.replace(",","."));return c>0?a+c:a},0)),g.push({id:b,percentage:0,length:d.length,sum:c,avg:Math.round(c/d.length*10)/10})),e.length&&(c=Math.round(_.reduce(e,function(a,b){var c=parseFloat(b.sum.replace(",","."));return c>0?a+c:a},0)),h.push({id:b,percentage:0,length:e.length,sum:c,avg:Math.round(c/e.length*10)/10}))}),g=_.sortBy(g,function(a){return a.sum}).reverse(),h=_.sortBy(h,function(a){return a.sum}).reverse(),a.totalOutcome=_.reduce(g,function(a,b){return a+parseInt(b.sum)},0),a.totalIncome=_.reduce(h,function(a,b){return a+parseInt(b.sum)},0),a.outcome=g,a.income=h,b(function(){a.outcome=_.map(a.outcome,function(a){return a.percentage=Math.round(a.sum/g[0].sum*100),a}),a.income=_.map(a.income,function(a){return a.percentage=Math.round(a.sum/h[0].sum*100),a}),a.loading=!1},3e3),a.loaded=!0,a.mode="outcome"};a.changeMode=function(b){a.mode=b}}]).directive("customOnChange",function(){return{restrict:"A",link:function(a,b,c){var d=b.scope()[c.customOnChange];b.bind("change",d)}}}),angular.module("nordeashApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("nordeashApp").service("Bank",function(){var a={nordea:{delimiter:new RegExp('(	(?=(?:(?:[^"]*"){2})*[^"]*$))',"g"),date:0,sum:3,target:4,startRow:3},osuuspankki:{delimiter:new RegExp(";","g"),date:0,sum:2,target:5,startRow:1}};return{upload:function(b,c,d){c=c.toLowerCase();var e=document.getElementById(b),f=/^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/,g=a[c].delimiter;if(f.test(e.value.toLowerCase()))if("undefined"!=typeof FileReader){var h=new FileReader;h.onload=function(b){for(var e=[],f=b.target.result.split("\n"),h=a[c].startRow;h<f.length;h++){f[h]=f[h].replace(g,"{;}");var i=f[h].split("{;}").slice(0,6);i[a[c].date]&&i[a[c].sum]&&e.push({date:i[a[c].date],sum:i[a[c].sum],target:i[a[c].target]})}d(e)},h.readAsText(e.files[0])}else alert("This browser does not support HTML5.");else alert("Please upload a valid CSV/TXT file.")}}}),angular.module("nordeashApp").service("Chart",function(){return{chartdata:[{labels:["Monday","Tuesday","Wednesday","Thursday","Friday"],datasets:[{label:"underscore",fillColor:"rgba(0,96,112,0.1)",strokeColor:"#006070",pointColor:"#006070",pointStrokeColor:"#006070",pointHighlightFill:"#fff",data:_.sortBy(_.range(5),function(a){return Math.random(1)})}]}],chartoptions:{animation:!0,animationSteps:60,animationEasing:"easeOutQuart",showScale:!1,scaleOverride:!1,scaleSteps:null,scaleStepWidth:null,scaleStartValue:null,scaleLineColor:"rgba(0,0,0,.0)",scaleLineWidth:1,scaleShowLabels:!1,scaleLabel:"<%=value%>",scaleIntegersOnly:!0,scaleBeginAtZero:!1,scaleFontFamily:"'Segoe UI','Helvetica Neue', 'Helvetica', 'Arial', sans-serif",scaleFontSize:12,scaleFontStyle:"100",scaleFontColor:"#666",responsive:!0,maintainAspectRatio:!1,showTooltips:!0,tooltipEvents:["mousemove","touchstart","touchmove"],tooltipFillColor:"rgba(63,68,100,0.7)",tooltipFontFamily:"'Helvetica Neue', 'Helvetica', 'Segoe UI','Roboto', sans-serif",tooltipFontSize:20,tooltipFontStyle:"100",tooltipFontColor:"#fff",tooltipTitleFontFamily:"'Helvetica Neue', 'Helvetica', 'Segoe UI','Roboto', sans-serif",tooltipTitleFontSize:12,tooltipTitleFontStyle:"100",tooltipTitleFontColor:"#fff",tooltipYPadding:15,tooltipXPadding:15,tooltipCaretSize:8,tooltipCornerRadius:0,tooltipXOffset:10,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value %>",multiTooltipTemplate:"<%= value %>â‚¬",scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.1)",scaleGridLineWidth:1,bezierCurve:!0,bezierCurveTension:.4,pointDot:!0,pointDotRadius:6,pointDotStrokeWidth:3,pointHitDetectionRadius:30,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].lineColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'}}});